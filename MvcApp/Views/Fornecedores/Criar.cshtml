@model MvcApp.ViewModels.Fornecedor.CriarFornecedorViewModel;
@{
    ViewData["Title"] = "Criar Fornecedor";
}

<h1>Criar Fornecedor</h1>

<form asp-action="Criar" method="post" enctype="multipart/form-data">
    <div class="mb-3">
        <label asp-for="Nome"></label>
        <input asp-for="Nome" class="form-control" placeholder="Ex: Nova Eletrônicos" />
        <span asp-validation-for="Nome" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Cnpj"></label>

        <!-- Campo REAL: validado pelo MVC -->
        <input asp-for="Cnpj" type="hidden" id="Cnpj" />

        <!-- Campo VISUAL: só para digitação -->
        <input type="text"
           id="CnpjMascara"
           class="form-control"
           placeholder="Ex: 12.345.678/0001-99" />

        <span asp-validation-for="Cnpj" class="text-danger"></span>
    </div>
    
    <div class="mb-3">
        <label asp-for="Cep"></label>

        <input asp-for="Cep" type="hidden" id="Cep" />

        <input type="text"
               id="CepMascara"
               class="form-control"
               placeholder="Ex: 12345-678" />

        <span asp-validation-for="Cep" class="text-danger"></span>
    </div>
    
    <div class="mb-3">
        <select asp-for="SegmentoId" class="form-select">
            @foreach (var segmento in Model.Segmentos ?? [])
            {
                <option value="@segmento.Id">@segmento.Nome</option>
            }
        </select>
        <span asp-validation-for="SegmentoId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="FotoPerfil" class="form-label">Foto do fornecedor</label>
        <input asp-for="FotoPerfil" 
               type="file" 
               accept="image/jpeg, image/png" 
               class="form-control" />
        <span asp-validation-for="FotoPerfil" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Criar Fornecedor</button>
    <a class="btn btn-secondary" asp-action="Index">Cancelar</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://cdn.jsdelivr.net/npm/imask@7/dist/imask.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const cnpjHidden = document.getElementById('Cnpj');
            const cnpjMaskEl = document.getElementById('CnpjMascara');
            const cepHidden = document.getElementById('Cep');
            const cepMaskEl = document.getElementById('CepMascara');
            
            if (cnpjMaskEl && cnpjHidden) {
                const cnpjMask = IMask(cnpjMaskEl, { mask: '00.000.000/0000-00' });

                // Se já vier valor do servidor (ex: post com erro), aplica no campo visual
                if (cnpjHidden.value && cnpjHidden.value.length === 14) {
                    cnpjMask.unmaskedValue = cnpjHidden.value;
                }

                // Sempre que o usuário digitar, atualiza o hidden com o valor puro
                cnpjMask.on('accept', function () {
                    cnpjHidden.value = cnpjMask.unmaskedValue;
                });
            }
            
            if (cepMaskEl && cepHidden) {
                const cepMask = IMask(cepMaskEl, { mask: '00000-000' });

                if (cepHidden.value && cepHidden.value.length === 8) {
                    cepMask.unmaskedValue = cepHidden.value;
                }

                cepMask.on('accept', function () {
                    cepHidden.value = cepMask.unmaskedValue;
                });
            }

            // Segurança extra no submit
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function () {
                    if (window.cnpjMask && cnpjHidden) {
                        cnpjHidden.value = cnpjMask.unmaskedValue;
                    }
                    if (window.cepMask && cepHidden) {
                        cepHidden.value = cepMask.unmaskedValue;
                    }
                });
            }
        });
    </script>
}